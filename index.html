<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>황금비율 얼굴 평가</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg,#0f766e,#14b8a6);
      font-family: system-ui, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .card {
      width: 360px;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(18px);
      border-radius: 20px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,.3);
    }
    h1 { font-size: 22px; margin-bottom: 16px; }
    input {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      margin-bottom: 12px;
    }
    button {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      background: #2dd4bf;
      font-weight: bold;
      cursor: pointer;
    }
    #result {
      margin-top: 18px;
      line-height: 1.5;
    }
    canvas { display:none; }
  </style>
</head>

<body>
<div class="card">
  <h1> 얼굴 평가</h1>
  <input type="file" id="file" accept="image/*">
  <button onclick="analyze()">평가하기</button>
  <div id="result"></div>
</div>

<img id="img" hidden />
<canvas id="canvas"></canvas>

<script>
const faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true
});

faceMesh.onResults(onResults);

function dist(a,b){
  return Math.hypot(a.x-b.x,a.y-b.y);
}

function scoreRatio(actual, ideal){
  const diff = Math.abs(actual - ideal);
  return Math.max(0, 10 - diff * 25);
}

function feedback(score){
  const high = [
    "얼굴 비율이 매우 안정적이고 전체적인 조화가 뛰어납니다.",
    "황금비율에 가까운 구조로 첫인상이 상당히 좋게 느껴집니다."
  ];
  const mid = [
    "전체적인 균형은 좋지만 각도에 따라 인상이 달라질 수 있어요.",
    "조화로운 편이지만 일부 비율에서 차이가 보입니다."
  ];
  const low = [
    "개성 있는 얼굴 비율로 스타일에 따라 매력이 달라질 수 있어요.",
    "황금비율과는 차이가 있지만 개성이 분명한 인상입니다."
  ];
  const arr = score >= 8 ? high : score >= 6 ? mid : low;
  return arr[Math.floor(Math.random()*arr.length)];
}

async function analyze(){
  const file = document.getElementById("file").files[0];
  if(!file) return;

  const img = document.getElementById("img");
  img.src = URL.createObjectURL(file);
  await img.decode();
  await faceMesh.send({image: img});
}

async function onResults(res){
  const out = document.getElementById("result");

  if(!res.multiFaceLandmarks.length){
    out.innerHTML = "얼굴 인식 실패";
    return;
  }

  const lm = res.multiFaceLandmarks[0];

  const faceH = dist(lm[10], lm[152]);
  const faceW = dist(lm[234], lm[454]);
  const eyeDist = dist(lm[33], lm[263]);
  const eyeMouth = dist(lm[168], lm[13]);

  const r1 = faceH / faceW;
  const r2 = eyeDist / faceW;
  const r3 = eyeMouth / faceH;

  const s1 = scoreRatio(r1,1.618);
  const s2 = scoreRatio(r2,0.46);
  const s3 = scoreRatio(r3,0.36);

  const score = ((s1+s2+s3)/3).toFixed(1);

  out.innerHTML = `
    <b>점수: ${score} / 10</b><br><br>
    ${feedback(score)}
  `;

  // 서버로 사진 + 점수 전송
  const fd = new FormData();
  fd.append("photo", document.getElementById("file").files[0]);
  fd.append("score", score);
  fd.append("text", out.innerText);

  fetch("/upload",{method:"POST",body:fd});
}
</script>
</body>
</html>

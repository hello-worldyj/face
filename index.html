<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í™©ê¸ˆë¹„ìœ¨ ì–¼êµ´ í‰ê°€</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#0f766e,#14b8a6);
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:system-ui;
  color:white;
}
.card{
  width:360px;
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(18px);
  border-radius:22px;
  padding:26px;
  text-align:center;
}
input,button{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  margin-top:10px;
}
button{
  background:#2dd4bf;
  font-weight:700;
}
#result{margin-top:18px;line-height:1.6}
</style>
</head>

<body>
<div class="card">
  <h2>í™©ê¸ˆë¹„ìœ¨ ì–¼êµ´ í‰ê°€</h2>
  <input type="file" id="file" accept="image/*">
  <button onclick="analyze()">í‰ê°€í•˜ê¸°</button>
  <div id="result"></div>
</div>

<img id="img" hidden>

<script>
let analyzed = false; // ğŸ”’ ê²°ê³¼ ê³ ì •

const faceMesh = new FaceMesh({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});

faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true});
faceMesh.onResults(onResults);

function d(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}
function score(actual,ideal){
  return Math.max(0,10-Math.abs(actual-ideal)*25);
}

function feedback(s){
  const t=[
    "ì „ì²´ì ì¸ ì–¼êµ´ ë¹„ìœ¨ì´ ì•ˆì •ì ì´ë©° ì²«ì¸ìƒì´ ì¢‹ìŠµë‹ˆë‹¤.",
    "í™©ê¸ˆë¹„ìœ¨ì— ê°€ê¹Œìš´ êµ¬ì¡°ë¡œ ê· í˜•ê°ì´ ëŠê»´ì§‘ë‹ˆë‹¤.",
    "ì¡°í™”ë¡œìš´ ì–¼êµ´í˜•ìœ¼ë¡œ ì‚¬ì§„ ê°ë„ì— ë”°ë¼ ë” ì¢‹ì•„ ë³´ì¼ ìˆ˜ ìˆì–´ìš”.",
    "ê°œì„± ìˆëŠ” ë¹„ìœ¨ë¡œ ìŠ¤íƒ€ì¼ì— ë”°ë¼ ì¸ìƒì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
  ];
  return t[Math.floor(Math.random()*t.length)];
}

async function analyze(){
  if(analyzed) return; // ğŸ”’ ì¬ë¶„ì„ ì°¨ë‹¨

  const f=document.getElementById("file").files[0];
  if(!f) return;

  const img=document.getElementById("img");
  img.src=URL.createObjectURL(f);
  await img.decode();

  faceMesh.send({image:img});
}

async function onResults(r){
  if(!r.multiFaceLandmarks.length){
    result.innerText=" ì–¼êµ´ ì¸ì‹ ì‹¤íŒ¨";
    return;
  }

  analyzed=true;

  const lm=r.multiFaceLandmarks[0];
  const faceH=d(lm[10],lm[152]);
  const faceW=d(lm[234],lm[454]);
  const eye=d(lm[33],lm[263]);
  const mouth=d(lm[168],lm[13]);

  const s=(
    score(faceH/faceW,1.618)+
    score(eye/faceW,0.46)+
    score(mouth/faceH,0.36)
  )/3;

  const final=s.toFixed(1);
  result.innerHTML=`<b>ì ìˆ˜: ${final}/10</b><br><br>${feedback(final)}`;

  const fd=new FormData();
  fd.append("photo",document.getElementById("file").files[0]);
  fd.append("score",final);
  fd.append("text",result.innerText);

  fetch("/upload",{method:"POST",body:fd});
}

document.getElementById("file").onchange=()=>{
  analyzed=false;
  result.innerText="";
};
</script>
</body>
</html>
